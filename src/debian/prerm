#!/bin/bash
#--------------------------------------
# Script Name:  prerm
# Version:      1.1
# Authors:      skurka@ukaachen.de, shuening@ukaachen.de, akombeiz@ukaachen.de
# Date:         04 Nov 24
# Purpose:      Pre-removal script that handles WildFly service shutdown and cleanup of DWH deployment files during package upgrades.
#--------------------------------------

readonly OPERATION="${1}"

stop_wildfly() {
  echo "Stopping WildFly service..."
  if ! systemctl is-active --quiet wildfly; then
    echo "Service not running"
    return 0
  fi

  systemctl stop wildfly
  local count=0
  local max_wait=30
  while systemctl is-active --quiet wildfly; do
    if ((count >= max_wait)); then
      echo "Error: Service stop timeout after ${max_wait}s" >&2
      return 1
    fi
    sleep 1
    ((count++))
  done
}

cleanup_j2ee_deployments() {
  echo "Cleaning up deployments..."
  if ! compgen -G "${WILDFLY_DEPLOYMENTS}/dwh-j2ee-*" > /dev/null; then
    echo "No deployments found"
    return 0
  fi
  rm -f "${WILDFLY_DEPLOYMENTS}"/dwh-j2ee-*
}

main() {
  set -euo pipefail
  case "$OPERATION" in
    remove)
      # Runs during package removal before files are deleted.
      ;;
    upgrade)
      # Runs during package upgrade before installation of new package.
      stop_wildfly
      cleanup_j2ee_deployments
      ;;
  esac
}

main "$@"
