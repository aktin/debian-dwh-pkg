#!/bin/bash
#--------------------------------------
# Script Name:  prerm
# Version:      1.1
# Authors:      skurka@ukaachen.de, shuening@ukaachen.de, akombeiz@ukaachen.de
# Date:         04 Nov 24
# Purpose:      Pre-removal script that handles WildFly service shutdown and cleanup of DWH deployment files during package upgrades.
#--------------------------------------

readonly OPERATION="${1}"

# Source helper script from i2b2 package
source_i2b2_helper() {
  local helper_path="/usr/share/${I2B2_PACKAGE_NAME}/helper.sh"
  echo "Loading i2b2 helper script..."
  if [[ ! -f "${helper_path}" ]]; then
    echo "Error: i2b2 helper script not found at ${helper_path}" >&2
    return 1
  fi
  source "${helper_path}"
}

cleanup_j2ee_deployments() {
  local dir_wildfly_deployments="/opt/wildfly/standalone/deployments"
  echo "Cleaning up deployments..."
  if ! compgen -G "${dir_wildfly_deployments}/dwh-j2ee-*" > /dev/null; then
    echo "No deployments found"
    return 0
  fi
  rm -f "${dir_wildfly_deployments}"/dwh-j2ee-*
}

main() {
  set -euo pipefail
  case "$OPERATION" in
    remove)
      # Runs during package removal before files are deleted.
      ;;
    upgrade)
      # Runs during package upgrade before installation of new package.
      source_i2b2_helper
      stop_wildfly
      cleanup_j2ee_deployments
      ;;
  esac
}

main "$@"
