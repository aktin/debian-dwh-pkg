#!/bin/bash
#--------------------------------------
# Script Name:  preinst
# Version:      1.1
# Authors:      skurka@ukaachen.de, shuening@ukaachen.de, akombeiz@ukaachen.de
# Date:         04 Nov 24
# Purpose:      Pre-installation script that backs up aktin.properties during upgrades.
#--------------------------------------

readonly OPERATION="${1}"

backup_aktin_properties() {
  local path_aktin_properties="/etc/aktin/aktin.properties"
  echo "Backing up AKTIN configuration..."
  if [[ ! -f "${path_aktin_properties}" ]]; then
    echo "No configuration found to backup"
    return 0
  fi
  local path_backup="${path_aktin_properties%.*}_$(date +%Y%m%d_%H%M).${path_aktin_properties##*.}"
  if ! cp -f "${path_aktin_properties}" "${path_backup}"; then
    echo "Error: Failed to create backup at ${path_backup}" >&2
    return 1
  fi
}

main() {
  set -euo pipefail
  case "$OPERATION" in
    install)
      # Runs during installation before files have been unpacked.
      ;;
    upgrade)
      # Runs during package upgrade before files have been unpacked.
      backup_aktin_properties
      ;;
  esac
}

main "$@"
