#!/bin/bash
#--------------------------------------
# Script Name:  postrm
# Version:      1.2
# Author:       skurka@ukaachen.de, shuening@ukaachen.de, akombeiz@ukaachen.de
# Date:         08 Nov 24
# Purpose:      Cleans up after package files are removed by purging configurations, user data, database entries, and notifying users about remaining manual steps.
#--------------------------------------

log_info() { echo -e "\033[0;34m[INFO]\033[0m $1"; }
log_success() { echo -e "\033[0;32m[SUCCESS]\033[0m $1"; }
log_warn() { echo -e "\033[1;33m[WARN]\033[0m $1"; }
log_error() { echo -e "\033[0;31m[ERROR]\033[0m $1" >&2; }

readonly OPERATION="${1}"
readonly I2B2_PACKAGE_NAME="__I2B2_PACKAGE_NAME__"

# Source helper script from i2b2 package
source_i2b2_helper() {
  local helper_path="/usr/share/${I2B2_PACKAGE_NAME}/helper.sh"
  log_info "Loading i2b2 helper script..."
  if [[ ! -f "${helper_path}" ]]; then
    log_error "i2b2 helper script not found at ${helper_path}"
    return 1
  fi
  source "${helper_path}"
  log_success "Helper script loaded"
}

disable_apache_reverse_proxy_config() {
  log_info "Removing Apache proxy configuration..."
  a2disconf aktin-j2ee-reverse-proxy >/dev/null 2>&1 || true
  rm -f /etc/apache2/conf-available/aktin-j2ee-reverse-proxy.conf
  systemctl restart apache2 || true
  log_success "Apache proxy configuration removed"
}

ask_for_disabling_proxy_http_module() {
  log_info "Checking proxy module status..."
  . /usr/share/debconf/confmodule
  db_input high "${DPKG_MAINTSCRIPT_PACKAGE}/dis_apache2_proxy_http" || true
  db_go || true
  db_fset "${DPKG_MAINTSCRIPT_PACKAGE}/dis_apache2_proxy_http" seen false
  db_get "${DPKG_MAINTSCRIPT_PACKAGE}/dis_apache2_proxy_http"

  if [ "$RET" = "Yes" ]; then
    a2dismod proxy_http >/dev/null || true
    systemctl restart apache2 || true
    log_success "Proxy module disabled"
 fi
}

remove_wildfly_artifacts() {
  log_info "Cleaning up WildFly artifacts..."
  rm -f /opt/wildfly/standalone/deployments/dwh-j2ee-*
  rm -f /opt/wildfly/standalone/configuration/aktin.properties
  rm -f /opt/wildfly/bin/aktin_config.cli
  log_success "WildFly artifacts removed"
}

remove_aktin_files() {
  log_info "Removing AKTIN properties and import scripts..."
  rm -f /etc/aktin/aktin.properties
  rm -rf /var/lib/aktin/import-scripts
  log_success "AKTIN files removed"
}

drop_aktin_database() {
  if ! command -v psql >/dev/null 2>&1 || ! systemctl is-active --quiet postgresql; then
    log_warn "PostgreSQL not available"
    return 0
  fi
  connect_to_psql
  log_info "Removing AKTIN database..."
  if [[ $(eval "${PSQL} -l" | grep "aktin" | wc -l) -gt 0 ]]; then
    eval "${PSQL} -v ON_ERROR_STOP=1" <<EOF >/dev/null
__AKTIN_DROP_STATEMENT__
EOF
    log_success "Database removed successfully"
  else
    log_info "Database already removed"
  fi
}

purge_aktin_files() {
  log_info "Purging AKTIN properties backups and files..."
  rm -rf /etc/aktin
  rm -rf /var/lib/aktin
  log_success "AKTIN files purged"
}

main() {
  set -euo pipefail
  source_i2b2_helper
  case "$OPERATION" in
    remove)
      # Runs during package removal after files have been deleted
      disable_apache_reverse_proxy_config
      ask_for_disabling_proxy_http_module
      remove_wildfly_artifacts
      remove_aktin_files
      ;;
    purge)
      # Runs during a purge after 'postrm remove' to delete all leftover files
      drop_aktin_database
      purge_aktin_files
      ;;
  esac
  check_and_start_service "wildfly"
}

main "$@"
